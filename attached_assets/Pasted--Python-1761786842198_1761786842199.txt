# ==============================================================================
# ğŸŒŸ ×©×œ×“ ×§×•×“ Python ×œ×”×’×©×” ××•×˜×•××˜×™×ª ×œ×¨×©×•×™×•×ª (××¡ ×”×›× ×¡×”, ××¢"×) - ××•×ª×× ×œ-2025
# ==============================================================================
import requests
import json
import base64
from datetime import datetime

# --- 1. ×”×’×“×¨×•×ª ×•××™×©×•×¨×™× (×—×•×‘×” ×œ×©××•×¨ ×‘×¡×•×“×•×ª/Secrets ×‘-Replit) ---
# ×›×ª×•×‘×•×ª ×”-API ×©×œ ×¨×©×•×ª ×”××¡×™× (Production Endpoints)
TOKEN_URL = "https://openapi.taxes.gov.il/shaam/longtimetoken/oauth2/token" 
INVOICE_API_URL = "https://api.taxes.gov.il/shaam/production/Invoices/" 

# ××™×©×•×¨×™× ×©×§×™×‘×œ×ª ××”×¨×©×•×ª (×—×•×‘×” ×œ×”×—×œ×™×£ ×‘×¢×¨×›×™× ×”×××™×ª×™×™×)
CLIENT_ID = "YOUR_CLIENT_ID_HERE" 
CLIENT_SECRET = "YOUR_CLIENT_SECRET_HERE" 
SCOPE = "invoice" 


def get_access_token():
    """×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª Access Token ×‘×××¦×¢×•×ª OAuth2 Client Credentials"""
    
    # ×™×¦×™×¨×ª ××—×¨×•×–×ª ××™××•×ª Base64
    credentials = f"{CLIENT_ID}:{CLIENT_SECRET}".encode('utf-8')
    base64_auth = base64.b64encode(credentials).decode('utf-8')
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "Authorization": f"Basic {base64_auth}"
    }
    
    data = {
        "grant_type": "client_credentials",
        "scope": SCOPE
    }
    
    print("... ×× ×¡×” ×œ×”×ª×—×‘×¨ ×œ×¨×©×•×ª ×”××¡×™× ×•×œ×§×‘×œ ××¡×™××•×Ÿ ×’×™×©×”...")
    try:
        response = requests.post(TOKEN_URL, headers=headers, data=data, timeout=10)
        response.raise_for_status()
        
        token_data = response.json()
        return token_data.get("access_token")
    
    except requests.exceptions.RequestException as e:
        print(f"âŒ ×©×’×™××ª ×‘×§×©×ª ×˜×•×§×Ÿ: {e}")
        # ×”×¦×’×ª ×ª×•×›×Ÿ ×”×ª×©×•×‘×” ×‘××§×¨×” ×©×œ ×©×’×™××” ×œ×§×‘×œ×ª ×¤×¨×˜×™× × ×•×¡×¤×™× ××”×¨×©×•×ª
        if 'response' in locals() and response.text:
             print(f"×ª×•×›×Ÿ ×©×’×™××”: {response.text}")
        return None


# --- 2. ××•×“×•×œ ×—×©×‘×•× ×™×ª ×™×©×¨××œ (××¢"× B2B 20,000 â‚ª+) ---
def create_invoice_json(data):
    """×‘× ×™×™×ª ××‘× ×” ×”-JSON ×”× ×“×¨×© ×œ×©×œ×™×—×ª ×—×©×‘×•× ×™×ª ×œ×§×‘×œ×ª ××¡×¤×¨ ×”×§×¦××”."""
    
    # ×¤×•×¨××˜ JSON ×‘×¡×™×¡×™ ××—×™×™×‘ - ×—×•×‘×” ×œ×•×•×“× ×©×›×œ ×”×©×“×•×ª ×ª×•×××™× ×œ×“×¨×™×©×•×ª ITA
    invoice_json = {
        "invoice_id": str(data.get("invoice_id")),
        "invoice_type": data.get("invoice_type", 1), # 1 = ×—×©×‘×•× ×™×ª ××¡
        "vat_number": data.get("supplier_vat_id"), # ××–×”×” ×× ×¤×™×§
        "union_vat_number": "000000000", # ×©×“×” ×—×•×‘×”
        "customer_vat_number": data.get("customer_vat_id"), # ××–×”×” ×œ×§×•×—
        "action": 1, # 1 = ×‘×§×©×ª ×”×§×¦××” ×—×“×©×”
        "amount_before_vat": data.get("amount_before_vat"), 
        "vat_amount": data.get("vat_amount"),
        "invoice_date": data.get("invoice_date"), # YYYY-MM-DD
        "total_amount": data.get("amount_before_vat") + data.get("vat_amount"),
        # ... ×”×•×¡×£ ×›××Ÿ ×©×“×•×ª ×—×•×‘×” × ×•×¡×¤×™× ×›×’×•×Ÿ ×¡×•×’ ×œ×§×•×—, ×¡×•×’ ×—×©×‘×•×Ÿ, ×¤×¨×˜×™ ×¡× ×™×£ ...
    }
    return invoice_json


def submit_for_allocation_number(access_token, invoice_data):
    """×©×•×œ×—×ª ××ª ×‘×§×©×ª ×”×§×¦××ª ×”××¡×¤×¨ ×œ×¨×©×•×ª ×”××¡×™×."""
    
    if not access_token:
        print("âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×”×’×©×” - ××™×Ÿ ××¡×™××•×Ÿ ×’×™×©×”.")
        return False
        
    invoice_json_data = create_invoice_json(invoice_data)
    
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }
    
    print(f"... ×©×•×œ×— ×‘×§×©×ª ×”×§×¦××” ×œ×—×©×‘×•× ×™×ª {invoice_data['invoice_id']}...")
    try:
        response = requests.post(INVOICE_API_URL, headers=headers, json=invoice_json_data, timeout=15)
        response.raise_for_status()
        
        result = response.json()
        
        if result.get("allocation_number"):
            print(f"âœ… ×”×¦×œ×—×”! ××¡×¤×¨ ×”×§×¦××”: {result['allocation_number']}")
            # ×›××Ÿ ×¦×¨×™×š ×œ×”×™×•×ª ×§×•×“ ×œ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×”×§×¦××” ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™× ×©×œ×š.
            return result
        else:
            # ×”×¨×©×•×ª ×”×—×–×™×¨×” 200 ××‘×œ ××™×Ÿ ××¡×¤×¨ ×”×§×¦××”, ×™×™×ª×›×Ÿ ×©×™×© ×©×’×™××•×ª ×¢×¡×§×™×•×ª ×‘×ª×•×š ×”-JSON
            print(f"âš ï¸ ×”×‘×§×©×” ×”×¦×œ×™×—×”, ××š ××™×Ÿ ××¡×¤×¨ ×”×§×¦××”: {result}")
            return result

    except requests.exceptions.HTTPError as errh:
        # ×©×’×™××•×ª API ×›×’×•×Ÿ 400 (Bad Request - ×¤×•×¨××˜ JSON ×©×’×•×™/× ×ª×•× ×™× ×—×¡×¨×™×)
        print(f"âŒ ×©×’×™××ª HTTP ×‘×”×’×©×”: {errh}")
        print(f"×ª×•×›×Ÿ ×ª×©×•×‘×” ××”×¨×©×•×ª: {response.text}")
        return False
    except requests.exceptions.RequestException as e:
        print(f"âŒ ×©×’×™××” ×›×œ×œ×™×ª ×‘××”×œ×š ×”×‘×§×©×”: {e}")
        return False


# --- 3. ××•×“×•×œ ×™×¦×™×¨×ª ×§×•×‘×¥ PCN874 (×“×™×•×•×— ××¢"× ×—×•×“×©×™) ---

def create_pcn874_file(transactions, reporting_period):
    """
    ×™×¦×™×¨×ª ×§×•×‘×¥ PCN874 ×œ×“×™×•×•×— ××¢"× ×ª×§×•×¤×ª×™.
    
    ×”×§×•×‘×¥ ×”×•× ×¤×•×¨××˜ ×˜×§×¡×˜×•××œ×™ ×§×‘×•×¢ ×”××—×•×œ×§ ×œ×—×œ×§×™×: ×›×•×ª×¨×ª, ×¢×¡×§××•×ª, ×›×•×ª×¨×ª ×ª×—×ª×•× ×”.
    ×™×© ×œ×•×•×“× ×©××•×¨×š ×”×©×“×•×ª ×•×”××§×•×“×“×™× ×ª×•×××™× ×œ×“×¨×™×©×•×ª 874.
    """
    
    # ×“×•×’××” ×œ× ×ª×•× ×™ ×›×•×ª×¨×ª (×™×© ×œ×”×—×œ×™×£ ×‘× ×ª×•× ×™× ×××™×ª×™×™×)
    supplier_vat = "512345678"
    report_type = "M" # M=×—×•×“×©×™, T=×“×• ×—×•×“×©×™
    
    # ×¤×•×¨××˜ ×ª×§×•×¤×”: YYYYMM
    period = reporting_period 
    
    # ×™×¦×™×¨×ª ×§×• ×”×›×•×ª×¨×ª (Header Record)
    header = f"H|{supplier_vat}|{period}|{report_type}|{datetime.now().strftime('%Y%m%d%H%M%S')}\n"
    
    transaction_records = ""
    total_records = 0
    
    # ×™×¦×™×¨×ª ×§×•×•×™ ×¢×¡×§××•×ª (Transaction Records)
    # ×™×© ×œ×—×–×•×¨ ×›××Ÿ ×¢×œ ×›×œ ×ª× ×•×¢×ª ×ª×©×•××•×ª/×ª×¤×•×§×•×ª ×©× ××¡×¤×” ×¢"×™ ×”-AI
    for tx in transactions:
        
        # ×”×§×•×“ ×× ×™×— ×©×§×™×™× ×©×“×” 'allocation_number'
        allocation_num = tx.get('allocation_number', '') # ×©×“×” ×”×§×¦××” (×—×•×‘×” ×œ-B2B 20K+)
        
        # ×¡×•×’ ×”×ª× ×•×¢×” (X=×ª×¤×•×§×•×ª/××›×™×¨×•×ª, T=×ª×©×•××•×ª/×§× ×™×•×ª)
        record_type = tx.get('record_type') 
        
        # ×§×• ×”×¢×¡×§×”: ×“×•×’××” ×œ×¤×•×¨××˜ (×™×© ×œ×•×•×“× ×¨×•×—×‘ ×©×“×•×ª ××“×•×™×§)
        line = f"D|{record_type}|{tx['vat_id_other']}|{tx['invoice_num']}|{tx['date']}|{tx['amount']}|{tx['vat_amount']}|{allocation_num}\n"
        transaction_records += line
        total_records += 1

    # ×™×¦×™×¨×ª ×§×• ×¡×™×›×•× (Footer Record)
    footer = f"F|{total_records}\n"
    
    full_content = header + transaction_records + footer
    
    file_name = f"PCN874_{supplier_vat}_{period}.txt"
    with open(file_name, "w", encoding="windows-1255") as f:
        f.write(full_content)
        
    print(f"âœ… ×§×•×‘×¥ PCN874 × ×•×¦×¨ ×‘×”×¦×œ×—×”: {file_name}")
    # ×§×•×‘×¥ ×–×” ×“×•×¨×© ×”×’×©×” ×™×“× ×™×ª/××•×˜×•××˜×™×ª ×“×¨×š ××¢×¨×›×ª ×”-SHAAM
    return file_name

# --- 4. ××•×“×•×œ ×™×¦×™×¨×ª ×§×•×‘×¥ 856 (× ×™×›×•×™×™×/××¡ ×”×›× ×¡×”) ---

def create_form856_file(payments, reporting_year):
    """
    ×™×¦×™×¨×ª ×§×•×‘×¥ × ×™×›×•×™×™× ×—×•×“×©×™/×©× ×ª×™ (×˜×•×¤×¡ 856).
    
    ×”×§×•×‘×¥ ××¤×¨×˜ × ×™×›×•×™ ××¡ ×‘××§×•×¨ ×©× ×•×›×” ××¡×¤×§×™× ×©××™× × ×—×‘×¨×•×ª.
    ×–×”×• ×§×•×‘×¥ ×˜×§×¡×˜ ××•×‘× ×” ×‘×¢×œ ×¨×•×—×‘ ×©×“×•×ª ×§×‘×•×¢.
    """
    
    # ×“×•×’××” ×œ× ×ª×•× ×™ ×›×•×ª×¨×ª (×™×© ×œ×”×—×œ×™×£ ×‘× ×ª×•× ×™× ×××™×ª×™×™×)
    filer_id = "512345678"
    
    # ×™×¦×™×¨×ª ×§×• ×›×•×ª×¨×ª: ×¨×•×—×‘ ×©×“×” ××—×™×™×‘ 
    header = f"HEADER{filer_id:0>9}{reporting_year}00\n"
    
    payment_records = ""
    total_records = 0

    # ×™×¦×™×¨×ª ×§×•×•×™ ×ª×©×œ×•× ×œ×¡×¤×§×™×
    for p in payments:
        # ×–×”×• ×§×• ×œ×“×•×’××”, ×™×© ×œ×•×•×“× ×¨×•×—×‘ ×©×“×•×ª ×§×‘×•×¢ (Fixed-Width)
        line = (
            f"DETAIL"
            f"{p['supplier_id']: <9}" # ×ª×¢×•×“×ª ×–×”×•×ª/×—.×¤. ×©×œ ×”×¡×¤×§
            f"{p['payment_date']: <8}" # ×ª××¨×™×š ×ª×©×œ×•× YYYYMMDD
            f"{p['gross_amount']:0>10}" # ×¡×›×•× ×‘×¨×•×˜×• (××™×•×©×¨ ×œ××¤×¡×™× ×•×¨×•×—×‘ ×§×‘×•×¢)
            f"{p['withholding_tax']:0>8}" # ×¡×›×•× × ×™×›×•×™ ××¡
            f"{'0' * 50}\n" # ×©×“×•×ª ×¨×™×§×™× × ×“×¨×©×™× × ×•×¡×¤×™× 
        )
        payment_records += line
        total_records += 1

    # ×™×¦×™×¨×ª ×§×• ×¡×™×›×•×
    footer = f"FOOTER{total_records:0>7}{'0' * 100}\n" 

    full_content = header + payment_records + footer
    
    file_name = f"Form856_{filer_id}_{reporting_year}.txt"
    with open(file_name, "w", encoding="windows-1255") as f:
        f.write(full_content)
        
    print(f"âœ… ×§×•×‘×¥ 856 × ×•×¦×¨ ×‘×”×¦×œ×—×”: {file_name}")
    return file_name


# ==============================================================================
# ğŸš€ ×”×¨×¦×ª ×”××¢×¨×›×ª - ×“×•×’××” ×œ-Workflow
# ==============================================================================

def run_automated_submission_workflow():
    
    # --- ×©×œ×‘ 1: ×”×©×’×ª ××¡×™××•×Ÿ ×’×™×©×” ---
    access_token = get_access_token()
    if not access_token:
        print("ğŸ›‘ ×¢×¦×™×¨×ª ×”×ª×”×œ×™×š: ×›×©×œ ×‘××•×ª× ×˜×™×§×¦×™×” ××•×œ ×¨×©×•×ª ×”××¡×™×.")
        return

    print(f"âœ… ××¡×™××•×Ÿ ×’×™×©×” ×”×ª×§×‘×œ ×‘×”×¦×œ×—×”: {access_token[:20]}...")
    
    # --- ×©×œ×‘ 2: ×”×’×©×ª ×—×©×‘×•× ×™×•×ª ××œ×§×˜×¨×•× ×™×•×ª (××¢"× 20,000 â‚ª+) ---
    
    # × ×ª×•× ×™ ×‘×“×™×§×” (×™×© ×œ×”×—×œ×™×£ ×‘×©×œ×™×¤×” ××‘×¡×™×¡ ×”× ×ª×•× ×™× ×©×œ×š!)
    invoices_to_submit = [
        {
            "invoice_id": 1001,
            "supplier_vat_id": "512345678",
            "customer_vat_id": "518765432",
            "amount_before_vat": 25000.00,
            "vat_amount": 4250.00,
            "invoice_date": "2025-01-20"
        },
        # ... ×›××Ÿ × ×›× ×¡×•×ª ×©××¨ ×”×—×©×‘×•× ×™×•×ª ×©×¢×‘×¨×• ×¡×™×•×•×’ AI ×•×“×•×¨×©×•×ª ×”×§×¦××” ...
    ]
    
    updated_invoices = []
    for inv in invoices_to_submit:
        result = submit_for_allocation_number(access_token, inv)
        if result and result.get("allocation_number"):
            inv['allocation_number'] = result['allocation_number']
        updated_invoices.append(inv)
        
    print("-----------------------------------------")
    
    # --- ×©×œ×‘ 3: ×™×¦×™×¨×ª ×“×•×— ××¢"× ×—×•×“×©×™ (PCN874) ---
    # ×›××Ÿ × ×›× ×¡×™× ×’× ×”× ×ª×•× ×™× ×©×œ ×—×©×‘×•× ×™×•×ª ×”-B2B ×•×’× ×›×œ ×™×ª×¨ ×”×ª× ×•×¢×•×ª (×§× ×™×•×ª/××›×™×¨×•×ª)
    
    # ×“×•×’××” ×œ× ×ª×•× ×™ PCN874 (×›×•×œ×œ ×”× ×ª×•×Ÿ ×©×œ ××¡×¤×¨ ×”×”×§×¦××” ××”×©×œ×‘ ×”×§×•×“×)
    pcn874_transactions = [
        {'record_type': 'X', 'vat_id_other': '518765432', 'invoice_num': 1001, 'date': '20250120', 'amount': 25000.00, 'vat_amount': 4250.00, 'allocation_number': 'A9B8C7D6E5'}, # ×”×—×©×‘×•× ×™×ª ×©×”×•×’×©×”
        {'record_type': 'T', 'vat_id_other': '600000000', 'invoice_num': 2005, 'date': '20250125', 'amount': 1000.00, 'vat_amount': 170.00, 'allocation_number': ''} # ×—×©×‘×•× ×™×ª ×§×˜× ×”/×¨×›×™×©×”
        # ...
    ]
    
    pcn_file = create_pcn874_file(pcn874_transactions, "202501")
    # ×§×•×‘×¥ ×–×” ××•×›×Ÿ ×œ×©×œ×™×—×” ×“×¨×š ×××©×§ ×”×”×’×©×” ×©×œ ××¢"×
    print("-----------------------------------------")


    # --- ×©×œ×‘ 4: ×™×¦×™×¨×ª ×“×•×— × ×™×›×•×™×™× (×˜×•×¤×¡ 856) ---
    
    # × ×ª×•× ×™ ×ª×©×œ×•××™× ×œ×¡×¤×§×™× ×¤×¨×˜×™×™× (×™×© ×œ×”×—×œ×™×£ ×‘×©×œ×™×¤×” ××‘×¡×™×¡ ×”× ×ª×•× ×™× ×©×œ×š!)
    payments_data = [
        {'supplier_id': '123456789', 'payment_date': '20250130', 'gross_amount': 5000, 'withholding_tax': 100},
        # ...
    ]
    
    form856_file = create_form856_file(payments_data, "2025")
    # ×§×•×‘×¥ ×–×” ××•×›×Ÿ ×œ×©×œ×™×—×” ×“×¨×š ×××©×§ ×”×”×’×©×” ×©×œ ××¡ ×”×›× ×¡×”
    print("-----------------------------------------")
    
    # ×“×¨×™×©×•×ª ×‘×™×˜×•×— ×œ××•××™ (××‘×˜"×œ) ×“×•×¨×©×•×ª ××•×“×•×œ × ×•×¡×£ ×•××•×¨×›×‘ ×œ×˜×™×¤×•×œ ×‘×©×›×¨ ×•××™× ×Ÿ ×›×œ×•×œ×•×ª ×›××Ÿ.
    print("âœ… ×¡×™×•× ×ª×”×œ×™×š ×¢×‘×•×“×”. ×”×§×‘×¦×™× × ×•×¦×¨×•. × ×“×¨×©×ª ×”×©×œ××” ×œ××•×“×•×œ ××‘×˜\"×œ ×•×©×œ×™×—×ª ×”× ×ª×•× ×™× ×œ-API.")


# --- ×”×¤×¢×œ×” ×¨××©×™×ª ---
if __name__ == "__main__":
    run_automated_submission_workflow()
