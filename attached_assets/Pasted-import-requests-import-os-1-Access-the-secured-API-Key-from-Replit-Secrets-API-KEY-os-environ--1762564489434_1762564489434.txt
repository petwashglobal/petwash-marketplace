import requests
import os

# 1. Access the secured API Key from Replit Secrets
API_KEY = os.environ.get('GOOGLE_WEATHER_API_KEY')

# Example location (Caulfield North, VIC, Australia)
LATITUDE = -37.8732
LONGITUDE = 145.0210

if not API_KEY:
    print("Error: GOOGLE_WEATHER_API_KEY not found in Replit Secrets.")
else:
    # 2. Construct the API URL for Current Conditions
    # This is a general structure, the exact endpoint may require full URL encoding.
    ENDPOINT = "https://weather.googleapis.com/v1/currentConditions:lookup"
    
    # The Google Weather API uses POST requests for lookups
    headers = {
        'Content-Type': 'application/json'
    }
    
    # Body containing location and key (though the key can be a query param too)
    payload = {
        "location": {
            "latitude": LATITUDE,
            "longitude": LONGITUDE
        }
    }
    
    request_url = f"{ENDPOINT}?key={API_KEY}"
    
    print(f"Testing Google Weather API for {LATITUDE}, {LONGITUDE}...")

    # 3. Make the POST request and test
    try:
        response = requests.post(request_url, headers=headers, json=payload)
        data = response.json()

        # 4. Retest (Check the response for success)
        if response.status_code == 200:
            print("\n✅ API Test Successful!")
            
            # Navigate the JSON response (keys might vary slightly)
            current_temp = data.get('currentConditions', {}).get('temperature', {}).get('value')
            unit = data.get('currentConditions', {}).get('temperature', {}).get('unit')
            condition = data.get('currentConditions', {}).get('conditions', [{}])[0].get('description')
            
            print(f"Current Temperature: {current_temp} {unit}")
            print(f"Conditions: {condition}")
            
        else:
            print(f"❌ API Request Failed. Status Code: {response.status_code}")
            print(f"Error Details: {data}")

    except requests.exceptions.RequestException as e:
        print(f"❌ Network Error: {e}")
