// Data to simulate the pet's persistent record
let busterPetRecord = {
    name: 'Buster',
    lastNailTrim: new Date('2025-10-05'),
    groomingHistory: [] // Stores past reports
};

// --- CORE LOGIC: CHECKLIST TO ACTION PLAN ---
// This is the intelligent mapping that drives the owner's tools.
const smartActionMap = {
    // Metric: [Condition Value, Critical Message, Next Action Tip]
    "matted": ["Found Matting (Severe)", "Requires daily short brushes for 7 days to prevent hot spots.", "Suggest early rebooking for deshedding."],
    "redness": ["Skin Irritation Noted", "Apply prescribed anti-itch cream to affected areas twice daily.", "Avoid harsh shampoos for 2 weeks."],
    "long": ["Nails Are Very Long", "Book a quick nail trim in 3 weeks, not 6.", "Use an emery board between appointments."],
};

function generateReportCard(petName, groomerID) {
    const checklist = document.getElementById('groomerChecklist');
    const checkboxes = checklist.querySelectorAll('input[type="checkbox"]:checked');
    const carePlanList = document.getElementById('carePlanList');
    const snapshotSummary = document.getElementById('snapshotSummary');
    const reportBox = document.getElementById('ownerReportCard');
    
    carePlanList.innerHTML = '';
    let criticalFindings = [];
    let summaryText = `Great session! ${petName}'s coat is clean and shiny.`;

    // 1. Process Checked Items and Generate Actions
    checkboxes.forEach(box => {
        const metric = box.getAttribute('data-metric');
        const value = box.getAttribute('data-value');

        if (metric === 'coatCondition' && value === 'matted') {
            const [finding, criticalMsg, actionTip] = smartActionMap['matted'];
            criticalFindings.push(finding);
            
            const li = document.createElement('li');
            li.className = 'care-critical';
            li.innerHTML = `**CRITICAL ACTION: ${criticalMsg}** <br> *Tip: ${actionTip}*`;
            carePlanList.appendChild(li);
        }

        if (metric === 'skinIssue' && value === 'redness') {
             const [finding, criticalMsg, actionTip] = smartActionMap['redness'];
            criticalFindings.push(finding);
            
            const li = document.createElement('li');
            li.className = 'care-critical';
            li.innerHTML = `**HEALTH ALERT: ${criticalMsg}** <br> *Tip: ${actionTip}*`;
            carePlanList.appendChild(li);
        }

        if (metric === 'nailLength' && value === 'long') {
            const [finding, criticalMsg, actionTip] = smartActionMap['long'];
            criticalFindings.push(finding);
            
            const li = document.createElement('li');
            li.innerHTML = `**Next Nail Trim Alert:** ${criticalMsg} <br> *Tip: ${actionTip}*`;
            carePlanList.appendChild(li);
        }
    });

    // 2. Generate Smart Snapshot Summary
    const now = new Date();
    const nextNailDueDate = new Date(busterPetRecord.lastNailTrim.getTime());
    nextNailDueDate.setDate(nextNailDueDate.getDate() + 42); // Standard 6 weeks (42 days)

    summaryText = `
        Wash Complete: ${now.toLocaleDateString()}. <br>
        Next Full Groom Due: ${new Date(now.setMonth(now.getMonth() + 1)).toLocaleDateString()}. <br>
        Next Nail Check: ${criticalFindings.includes(smartActionMap['long'][0]) ? '3 Weeks' : nextNailDueDate.toLocaleDateString()}.
    `;
    
    snapshotSummary.innerHTML = summaryText;

    // 3. Update History (Backend simulation)
    busterPetRecord.groomingHistory.push({
        date: now.toISOString().split('T')[0],
        groomer: groomerID,
        findings: criticalFindings
    });

    // 4. Show the Owner's Report Card
    reportBox.style.display = 'block';
}

// --- OWNER HELPFUL TOOL: Digital Sharing ---
function shareReportCard() {
    const findings = busterPetRecord.groomingHistory[busterPetRecord.groomingHistory.length - 1].findings;
    const shareMessage = `
        Hey sister/sitter! Buster's groom is done! ðŸ›
        
        ðŸš¨ CRITICAL CARE PLAN:
        ${document.getElementById('carePlanList').textContent.trim()}
        
        ðŸ“… Next Nail Check: ${document.getElementById('snapshotSummary').textContent.split('Next Nail Check: ')[1].split('.')[0]}.
        
        (This message is auto-generated by the Smart Pet App.)
    `;
    
    // Simulate copying the content to the clipboard for easy pasting into WhatsApp/iMessage
    navigator.clipboard.writeText(shareMessage).then(() => {
        alert("Smart Care Plan copied to clipboard! Ready to share with anyone managing Buster.");
    }).catch(err => {
        console.error('Could not copy text: ', err);
        alert("Copy failed. See console for details.");
    });
}
