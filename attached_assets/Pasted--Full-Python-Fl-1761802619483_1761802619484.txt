# ==============================================================================
# ğŸŒŸ Full Python/Flask Code: Tiered Loyalty Program System (2025-2026)
# ==============================================================================

from flask import Flask, request, jsonify, render_template
from flask_sqlalchemy import SQLAlchemy
from flask_admin import Admin
from flask_admin.contrib.sqla import ModelView
from datetime import datetime
import json

# --- 1. FLASK APPLICATION AND DATABASE SETUP ---
app = Flask(__name__)
# ×©×™××•×© ×‘-SQLite ×¤×©×•×˜ ×¢×‘×•×¨ Replit/Demo. ×‘×¡×‘×™×‘×ª Production ×™×© ×œ×”×©×ª××© ×‘-PostgreSQL/MySQL
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///loyalty_db.sqlite3'
app.config['SECRET_KEY'] = 'a_very_secret_key_for_2026'
app.config['FLASK_ADMIN_SWATCH'] = 'flatly'

db = SQLAlchemy(app)
admin = Admin(app, name='Loyalty Admin Dashboard ğŸš€', template_mode='bootstrap3')


# --- 2. DATABASE MODELS (ORM) ---
class Customer(db.Model):
    """××•×“×œ ×œ× ×™×”×•×œ ×¤×¨×˜×™ ×”×œ×§×•×— ×•×¡×˜×˜×•×¡ ×”× ××× ×•×ª ×©×œ×•."""
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(80), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    phone = db.Column(db.String(20), unique=True, nullable=True)
    total_spent = db.Column(db.Float, default=0.0)
    points = db.Column(db.Integer, default=0)
    tier = db.Column(db.String(20), default='Bronze')
    
    # 2025-2026 Feature: last_activity for churn prediction/re-engagement
    last_activity = db.Column(db.DateTime, default=datetime.utcnow)

    def __repr__(self):
        return f'<Customer {self.email}>'

class Transaction(db.Model):
    """××•×“×œ ×œ×ª×™×¢×•×“ ×›×œ ×”×¢×¡×§××•×ª ×œ×¦×‘×™×¨×ª × ×§×•×“×•×ª."""
    id = db.Column(db.Integer, primary_key=True)
    customer_id = db.Column(db.Integer, db.ForeignKey('customer.id'), nullable=False)
    amount = db.Column(db.Float, nullable=False)
    points_earned = db.Column(db.Integer, nullable=False)
    transaction_date = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relationship for easy lookup
    customer = db.relationship('Customer', backref=db.backref('transactions', lazy=True))

    def __repr__(self):
        return f'<Transaction {self.id} for Cust {self.customer_id}>'

class Reward(db.Model):
    """××•×“×œ ×œ× ×™×”×•×œ ×¤×¨×¡×™ ×”××•×¢×“×•×Ÿ."""
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    points_cost = db.Column(db.Integer, nullable=False)
    min_tier = db.Column(db.String(20), default='Bronze') # Feature: Tier restriction

    def __repr__(self):
        return f'<Reward {self.name}>'

# --- 3. LOYALTY LOGIC ---
TIER_RULES = {
    'Bronze': {'min_spent': 0, 'multiplier': 1},
    'Silver': {'min_spent': 500, 'multiplier': 1.5},
    'Gold':   {'min_spent': 2000, 'multiplier': 2}
}

def calculate_points_and_tier(customer, amount):
    """
    ××—×©×‘ × ×§×•×“×•×ª ×—×“×©×•×ª ×•××¢×“×›×Ÿ ××ª ×¨××ª ×”×œ×§×•×— (Tier).
    ×–×”×• ×§×•×“ '×× ×™×¢ ×”× ××× ×•×ª' (Loyalty Engine).
    """
    
    # 1. ×—×™×©×•×‘ × ×§×•×“×•×ª: 10 × ×§×•×“×•×ª ×œ×“×•×œ×¨/×©×§×œ ×‘×‘×¡×™×¡
    base_points = int(amount * 10)
    
    # 2. ×”×—×œ×ª ××›×¤×™×œ Tier × ×•×›×—×™
    multiplier = TIER_RULES.get(customer.tier)['multiplier']
    points_earned = int(base_points * multiplier)
    
    # 3. ×¢×“×›×•×Ÿ × ×ª×•× ×™ ×œ×§×•×—
    customer.total_spent += amount
    customer.points += points_earned
    customer.last_activity = datetime.utcnow()
    
    # 4. ×‘×“×™×§×ª ×¢×“×›×•×Ÿ Tier
    new_tier = customer.tier
    for tier_name, rule in TIER_RULES.items():
        if customer.total_spent >= rule['min_spent']:
            new_tier = tier_name
            
    # ×¢×“×›×•×Ÿ Tier ×× ×”×©×ª× ×”
    if new_tier != customer.tier:
        print(f"ğŸ‰ ×”×œ×§×•×— {customer.name} ×©×•×“×¨×’ ×-{customer.tier} ×œ-{new_tier}!")
        customer.tier = new_tier
        
    return points_earned

# --- 4. API ENDPOINTS (FOR MOBILE APPS - iOS/ANDROID) ---

@app.route('/api/v1/customer/<int:customer_id>', methods=['GET'])
def get_customer_status(customer_id):
    """API ×œ×©×œ×™×¤×ª ×¡×˜×˜×•×¡ ×œ×§×•×— ×¡×¤×¦×™×¤×™ (×œ×©×™××•×© ×‘××¤×œ×™×§×¦×™×•×ª ××•×‘×™×™×œ)."""
    customer = Customer.query.get(customer_id)
    if not customer:
        return jsonify({"error": "Customer not found"}), 404
        
    return jsonify({
        "id": customer.id,
        "name": customer.name,
        "email": customer.email,
        "points": customer.points,
        "tier": customer.tier,
        "total_spent": customer.total_spent,
        "rewards_available": Reward.query.filter(Reward.points_cost <= customer.points, Reward.min_tier == customer.tier).count()
    })

@app.route('/api/v1/transaction', methods=['POST'])
def record_transaction():
    """API ×œ×¨×™×©×•× ×¢×¡×§×” ×—×“×©×” ×•×¢×“×›×•×Ÿ × ×§×•×“×•×ª (××¢×¨×›×ª ×§×•×¤×”/POS)."""
    data = request.json
    
    # Input validation
    if not all(k in data for k in ('customer_id', 'amount')):
        return jsonify({"error": "Missing customer_id or amount"}), 400
        
    customer = Customer.query.get(data['customer_id'])
    amount = data['amount']
    
    if not customer:
        return jsonify({"error": "Customer not found"}), 404
    if amount <= 0:
        return jsonify({"error": "Amount must be positive"}), 400
        
    # ×¢×“×›×•×Ÿ × ×§×•×“×•×ª ×•×¨××”
    points_earned = calculate_points_and_tier(customer, amount)
    
    # ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×¢×¡×§×”
    new_transaction = Transaction(
        customer_id=customer.id, 
        amount=amount, 
        points_earned=points_earned
    )
    
    try:
        db.session.add(new_transaction)
        db.session.commit()
        return jsonify({
            "message": "Transaction recorded successfully",
            "points_earned": points_earned,
            "new_points_total": customer.points,
            "new_tier": customer.tier
        }), 201
    except Exception as e:
        db.session.rollback()
        return jsonify({"error": f"Database error: {str(e)}"}), 500

@app.route('/api/v1/redeem', methods=['POST'])
def redeem_reward():
    """API ×œ×¤×“×™×•×Ÿ ×¤×¨×¡ ×‘×××¦×¢×•×ª × ×§×•×“×•×ª (××¤×œ×™×§×¦×™×™×ª ××•×‘×™×™×œ)."""
    data = request.json
    
    if not all(k in data for k in ('customer_id', 'reward_id')):
        return jsonify({"error": "Missing customer_id or reward_id"}), 400
        
    customer = Customer.query.get(data['customer_id'])
    reward = Reward.query.get(data['reward_id'])
    
    if not customer or not reward:
        return jsonify({"error": "Customer or Reward not found"}), 404
        
    if customer.points < reward.points_cost:
        return jsonify({"error": "Insufficient points"}), 400

    # 2026 Feature: Tier Restriction check
    if TIER_RULES[customer.tier]['min_spent'] < TIER_RULES[reward.min_tier]['min_spent']:
         return jsonify({"error": f"Reward requires {reward.min_tier} tier or higher."}), 403

    # ×¤×“×™×•×Ÿ
    customer.points -= reward.points_cost
    
    try:
        db.session.commit()
        # ×™×© ×œ×©×œ×•×— ×›××Ÿ ×§×•×“ ×§×•×¤×•×Ÿ/××™×©×•×¨ ×œ××™×™×œ/××•×‘×™×™×œ ×©×œ ×”×œ×§×•×—
        return jsonify({
            "message": f"Successfully redeemed '{reward.name}' for {reward.points_cost} points.",
            "new_points_total": customer.points
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({"error": f"Database error: {str(e)}"}), 500


# --- 5. ADMIN DASHBOARD SETUP (UI/VISUALS) ---

# ×”×ª×××” ××™×©×™×ª ×©×œ ×ª×¦×•×’×ª ×”-Admin
class CustomerView(ModelView):
    column_list = ('id', 'name', 'email', 'tier', 'points', 'total_spent', 'last_activity')
    column_searchable_list = ('name', 'email', 'phone')
    column_filters = ('tier', 'last_activity')
    can_export = True
    
class TransactionView(ModelView):
    column_list = ('id', 'customer_id', 'customer', 'amount', 'points_earned', 'transaction_date')
    column_searchable_list = ('customer.email', 'customer.name')
    column_filters = ('transaction_date', 'points_earned')
    can_export = True

admin.add_view(CustomerView(Customer, db.session, name='Customers & Status ğŸ§‘â€ğŸ’»'))
admin.add_view(TransactionView(Transaction, db.session, name='Transactions ğŸ§¾'))
admin.add_view(ModelView(Reward, db.session, name='Rewards Catalog ğŸ'))


# --- 6. DASHBOARD HOME PAGE (The Visuals!) ---
@app.route('/')
def index():
    """×“×£ ×”×‘×™×ª ×©×œ ×”×“××©×‘×•×¨×“."""
    
    # KPI's for 2025-2026 Dashboard
    total_customers = Customer.query.count()
    total_points = db.session.query(db.func.sum(Customer.points)).scalar() or 0
    total_spent_lifetime = db.session.query(db.func.sum(Customer.total_spent)).scalar() or 0
    
    # Tier Distribution
    tier_data = db.session.query(Customer.tier, db.func.count(Customer.id)).group_by(Customer.tier).all()
    tier_counts = dict(tier_data)
    
    # 2025-2026 Churn/Engagement Metric: Customers with no activity in 90 days
    ninety_days_ago = datetime.utcnow() - datetime.timedelta(days=90)
    stale_customers = Customer.query.filter(Customer.last_activity < ninety_days_ago).count()
    
    # 
    
    # For Replit, we use a simple render template
    return render_template('dashboard.html', 
        total_customers=total_customers,
        total_points=f"{total_points:,.0f}",
        total_spent=f"{total_spent_lifetime:,.2f}",
        tier_counts=tier_counts,
        stale_customers=stale_customers
    )

# --- BOILERPLATE FOR INITIALIZATION AND RUNNING ---

@app.before_first_request
def create_tables():
    """×™×•×¦×¨ ××ª ×˜×‘×œ××•×ª ×”-DB ×•××›× ×™×¡ × ×ª×•× ×™ ×“××•."""
    db.create_all()
    
    if not Customer.query.first():
        print("ğŸ› ï¸ ××›× ×™×¡ × ×ª×•× ×™ ×“××• ×¨××©×•× ×™×™×...")
        db.session.add(Customer(name='××•×¨×™ ×™×©×¨××œ×™', email='uri@example.com', phone='050-1111111', total_spent=150.0, points=1500))
        db.session.add(Customer(name='× ×•×¢×” ×›×”×Ÿ', email='noa@example.com', phone='052-2222222', total_spent=700.0, points=10500, tier='Silver'))
        db.session.add(Reward(name='×§×•×¤×•×Ÿ 20% ×”× ×—×”', points_cost=500))
        db.session.add(Reward(name='××•×¦×¨ ×—×™× × (Gold)', points_cost=5000, min_tier='Gold'))
        db.session.commit()
        print("ğŸ› ï¸ × ×ª×•× ×™ ×“××• ×”×•×–× ×• ×‘×”×¦×œ×—×”. ×”-DB ××•×›×Ÿ.")


if __name__ == '__main__':
    # ×× ××ª×” ××©×ª××© ×‘-Replit, ×•×“× ×©×”×§×•×‘×¥ dashboard.html ×§×™×™×
    print("ğŸ”¥ ××¤×¢×™×œ ××ª ××¢×¨×›×ª Loyalty Program...")
    # × ×“×¨×© ×§×•×‘×¥ HTML ×¤×©×•×˜ ×‘×©× templates/dashboard.html
    app.run(host='0.0.0.0', port=5000)

