// 1. Dependency Setup (in build.gradle.kts)
// implementation("androidx.credentials:credentials:1.3.0") // Or latest
// implementation("com.google.android.libraries.identity.googleid:googleid:1.1.0") // Or latest

// 2. Define the Web Client ID (Web Application type)
// This is the Client ID of your Node.js backend, retrieved from string resources.
private val SERVER_CLIENT_ID = getString(R.string.google_web_client_id)

// 3. The Core Sign-In Function using Credential Manager
suspend fun signInWithGoogle(context: Context) {
    val credentialManager = CredentialManager.create(context)
    
    // 3a. Build the Google ID Token request, specifying your backend's Client ID
    val googleIdOption = GetGoogleIdOption(
        serverClientId = SERVER_CLIENT_ID,
        // The crucial step: request the Authorization Code for your server
        requestServerAuthCode = true, 
        filterByAuthorizedAccounts = true, 
        nonce = null // Implement nonce for replay attack prevention
    )

    // 3b. Build the main request
    val request = GetCredentialRequest.Builder()
        .addCredentialOption(googleIdOption)
        .build()

    try {
        val result = credentialManager.getCredential(context, request)
        
        // 4. Extract the Google Id Token and Auth Code
        if (result.credential is CustomCredential && result.credential.type == GoogleIdTokenCredential.TYPE_GOOGLE_ID_TOKEN_CREDENTIAL) {
            val googleIdCredential = GoogleIdTokenCredential.createFrom(result.credential.data)
            
            val idToken = googleIdCredential.idToken
            val authCode = googleIdCredential.serverAuthCode // The code your server needs!

            if (idToken != null && authCode != null) {
                println("âœ… Android: Received ID Token and Auth Code. Sending to backend.")
                // 5. Success! Now send to your Pet Wash Ltd Node.js Backend
                YourPetWashAPIService.sendAuthCodeToBackend(idToken, authCode)
                
                // 6. IMMEDIATE NEXT STEP: Prompt user for Passkey creation
                promptUserToCreatePasskey(context)
            }
        }
    } catch (e: Exception) {
        // Handle credential manager specific errors (e.g., user cancelled)
        println("Google Sign-In Failed: ${e.localizedMessage}")
    }
}
