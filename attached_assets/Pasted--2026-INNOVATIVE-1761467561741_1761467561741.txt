// ==============================================================================
// 2026 INNOVATIVE PET WASH HUB: SMART LOYALTY, CALENDAR, & NAYAX INTEGRATION
// ==============================================================================

// NOTE: In a real-world app, API keys and initial data would be securely loaded.
// Replace placeholders with your actual keys/endpoints.
const WEATHER_API_ENDPOINT = 'YOUR_WEATHER_API_ENDPOINT'; 
const ALLERGEN_API_ENDPOINT = 'YOUR_ALLERGEN_API_ENDPOINT';
const WASH_GOAL_DAYS = 14; // Target frequency for wash reminder

// --- MOCK PERSISTENT DATA STORE (Simulates database records for a loyal owner) ---
let LOYALTY_HUB = {
    PET_NAME: "Luna", 
    currentLoyaltyTier: 'Gold',
    eGiftBalance: 35.50, // Available e-Gift card balance
    lastWashDate: new Date('2025-10-20'), // Last wash date for the reminder calculation
    DISCOUNT_MAP: { 'Bronze': 0.05, 'Silver': 0.10, 'Gold': 0.15 },
    petLocation: 'New York, NY', // Current location for weather/allergens
    // Mock Groomer Findings for Smart Planner logic
    coatMetrics: { daysSinceLastWash: 6, isMatted: false, skinIrritation: true } 
};

// --- DOM ELEMENTS (In a production environment, HTML would be cleaner) ---
const getElement = (id) => document.getElementById(id);

// --- CORE LOYALTY & FINANCE TOOLS ---

function calculateNextWashReminder() {
    const lastWash = LOYALTY_HUB.lastWashDate;
    const nextDueDate = new Date(lastWash);
    nextDueDate.setDate(nextDueDate.getDate() + WASH_GOAL_DAYS);
    const daysUntilDue = Math.ceil((nextDueDate - new Date()) / (1000 * 60 * 60 * 24));
    
    let message, isAlert;
    if (daysUntilDue <= 0) {
        message = `âœ… **READY NOW!** Your pet is due for a fresh wash.`;
        isAlert = true;
    } else if (daysUntilDue <= 3) {
        message = `âš ï¸ **DUE SOON!** Wash is due in ${daysUntilDue} days on ${nextDueDate.toDateString()}.`;
        isAlert = true;
    } else {
        message = `ðŸ—“ï¸ On track! Next wash estimated: ${nextDueDate.toDateString()}.`;
        isAlert = false;
    }
    
    // Renders the reminder message in the hub UI
    const reminderEl = getElement('washReminder');
    if (reminderEl) {
        reminderEl.innerHTML = `<span class="${isAlert ? 'alert' : 'info'}">${message}</span>`;
    }
    
    // Auto-sync prompt for high priority
    if (isAlert) syncToDigitalCalendar(nextDueDate, LOYALTY_HUB.PET_NAME);
}


/**
 * SIMULATED Nayax QR Code Redemption (Digital Wallet / E-Gift)
 * Generates a link the user can save to Apple/Google Wallet for 1-tap redemption.
 */
function generateNayaxRedeemCode() {
    const redeemAmount = Math.min(10.00, LOYALTY_HUB.eGiftBalance); // Max $10 redeemable per session for UX/security
    if (redeemAmount <= 0) return { message: 'No gift card balance available.' };

    // --- ðŸ”‘ IMPRESSIVE CODE: Dynamic QR Token Generation (Simulated) ---
    // In reality, this token is securely generated by the Nayax API backend
    const uniqueToken = `NAYAX-GIFT-CODE-${LOYALTY_HUB.currentLoyaltyTier}-${Date.now()}`; 
    
    const redeemURL = `https://yourdomain.com/redeem?token=${uniqueToken}&amount=${redeemAmount.toFixed(2)}`;

    // Renders the redemption block
    const qrEl = getElement('qrCodeRedeemer');
    if (qrEl) {
        qrEl.innerHTML = `
            <p><strong><span style="color:#007bff;">$${redeemAmount.toFixed(2)}</span> Available!</strong></p>
            <p class="qr-message">Tap below to copy your unique digital wallet redemption code. Scan the QR at the K9000 station for instant credit!</p>
            <button onclick="copyToClipboard('${redeemURL}')">
                Copy Nayax QR Code Link
            </button>
        `;
    }
}

// --- ADVANCED CALENDAR SYNC (Best Owner Tool) ---

function syncToDigitalCalendar(dueDate, petName) {
    const title = `Wash Due: ${petName} (${LOYALTY_HUB.currentLoyaltyTier} Member)`;
    const details = `Time to look paw-some! Redeem your ${calculateMemberDiscount()}% loyalty discount at the K9000 station.`;
    const dateString = dueDate.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD format

    // Uses the iCalendar format, widely supported by Apple, Google, and Outlook calendars
    const calendarLink = `data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0ASUMMARY:${encodeURIComponent(title)}%0ADTSTART:${dateString}%0ADTEND:${dateString}%0ADESCRIPTION:${encodeURIComponent(details)}%0AEND:VEVENT%0AEND:VCALENDAR`;
    
    // In a final app, you'd open or download the link here.
    console.log(`[Calendar Sync]: Event link generated for ${dueDate.toDateString()}`);
}


// --- SMART COAT PLANNER (Contextual Recommendation) ---

async function getSmartWashRecommendation() {
    const recBox = getElement('smartRecommendation');
    if (!recBox) return;

    recBox.innerHTML = "Fetching local environmental data...";

    // --- MOCK EXTERNAL DATA FETCH (Simulates API calls) ---
    // In a real app, this would be an actual fetch request.
    const mockData = await new Promise(resolve => setTimeout(() => resolve({
        temp: 20 + Math.floor(Math.random() * 5), // 20-25 C
        rainChance: Math.floor(Math.random() * 40), // 0-40%
        pollenLevel: LOYALTY_HUB.coatMetrics.skinIrritation ? 8 : 2 // High if pet has skin issue
    }), 500)); 

    const { temp, rainChance, pollenLevel } = mockData;
    const petOverdue = LOYALTY_HUB.coatMetrics.daysSinceLastWash > WASH_GOAL_DAYS;
    
    let recommendationText = '';
    let recommendationClass = 'status-ideal';
    
    // --- ðŸ”‘ IMPRESSIVE CODE: Proactive Grooming Advice ---
    if (rainChance > 20 || temp < 10) {
        recommendationText = `âš ï¸ **POSTPONE WASH.** Bad outdoor conditions (${temp}Â°C, ${rainChance}% rain). Stick to indoor fun today.`;
        recommendationClass = 'status-warn';
    } else if (pollenLevel >= 7 && LOYALTY_HUB.coatMetrics.skinIrritation) {
        recommendationText = `ðŸš¨ **SKIN ALERT.** High Pollen Risk (Level ${pollenLevel}) + Skin Irritation. Delay wash to avoid worsening symptoms. Wipe down with water only.`;
        recommendationClass = 'status-warn';
    } else if (petOverdue) {
         recommendationText = `ðŸš€ **WASH ASAP!** Conditions are PERFECT (${temp}Â°C, low rain). Your pet is ${LOYALTY_HUB.coatMetrics.daysSinceLastWash} days post-wash.`;
    } else {
        recommendationText = `ðŸ‘ **OPTIMAL WINDOW.** Great day for a wash! Conditions are perfect (${temp}Â°C). Enjoy the ${LOYALTY_HUB.currentLoyaltyTier} discount.`;
    }

    recBox.className = `recommendation-box ${recommendationClass}`;
    recBox.innerHTML = recommendationText;
}

// --- UTILITY FUNCTIONS ---
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("Nayax Redemption Link copied! Paste this link into your Apple Wallet/Google Pay pass or Notes for quick redemption at the K9000 station.");
    });
}

// --- INITIALIZATION ---
window.onload = () => {
    // 1. Initial Render of Loyalty Data
    getElement('petNameDisplay').textContent = LOYALTY_HUB.PET_NAME;
    getElement('giftBalanceDisplay').textContent = `$${LOYALTY_HUB.eGiftBalance.toFixed(2)}`;
    getElement('loyaltyTierDisplay').textContent = `${LOYALTY_HUB.currentLoyaltyTier} (${calculateMemberDiscount()}% Discount)`;
    
    // 2. Run the core functions
    calculateNextWashReminder();
    generateNayaxRedeemCode();
    getSmartWashRecommendation(); 
};


// ==============================================================================
// Simplified HTML Structure (Embed this JS below the HTML elements)
// ==============================================================================
/*
<style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .hub-box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .balance-amount { font-size: 1.8em; color: #ff6b6b; font-weight: bold; }
    .alert { color: #d9534f; }
    .info { color: #337ab7; }
    .qr-redeem-block { background: #f0f8ff; padding: 15px; border: 2px dashed #007bff; border-radius: 8px; margin-top: 15px; }
    .recommendation-box { padding: 15px; border-radius: 8px; font-weight: bold; min-height: 50px; }
    .status-ideal { background-color: #e6ffed; border: 1px solid #4CAF50; }
    .status-warn { background-color: #fff3e0; border: 1px solid #ff9800; }
</style>

<h1>Wash Hub for <span id="petNameDisplay"></span></h1>

<div class="hub-box">
    <h3>Loyalty Wallet</h3>
    <p>Balance: <span id="giftBalanceDisplay" class="balance-amount"></span></p>
    <p>Tier: <span id="loyaltyTierDisplay"></span></p>
</div>

<div class="hub-box">
    <h3>Next Wash Calendar Reminder</h3>
    <p id="washReminder"></p>
</div>

<div class="hub-box" id="qrCodeRedeemer">
    </div>

<div class="hub-box">
    <h3>Smart Wash Planner</h3>
    <div id="smartRecommendation" class="recommendation-box"></div>
</div>
*/
